import subprocess
import time
import os

CLOUD_IMAGE = "noble-server-cloudimg-amd64.img"
USER_DATA = "user-data.yaml"
META_DATA = "meta-data.yaml"
SEED_ISO = "seed.iso"

HOST_LOG_DIR = "logs_host"
VM_LOG_DIR = "/mnt/logs"

QEMU_CMD = [
    "qemu-system-x86_64",
    "-m", "4G",
    "-smp", "2",
    "-cpu", "qemu64", #"host", if you can access the host cpu features, otherwise qemu64 (much slower, but more compatible)
    "-drive", f"file={CLOUD_IMAGE},format=qcow2",
    "-drive", f"file={SEED_ISO},format=raw",
    "-netdev", "user,id=net0",
    "-device", "virtio-net-pci,netdev=net0",
    "-virtfs", f"local,path={HOST_LOG_DIR},mount_tag=shared_logs,security_model=passthrough,id=logs",
    "-nographic"
]


def create_seed_iso():
    print("Creating seed.iso cloud-init...")
    if os.path.exists(SEED_ISO):
        os.remove(SEED_ISO)
    subprocess.check_call([
        "cloud-localds",
        SEED_ISO,
        USER_DATA,
        META_DATA
    ])


def ensure_host_log_dir():
    print("Checkings!")
    if not os.path.exists(HOST_LOG_DIR):
        os.makedirs(HOST_LOG_DIR)


def start_qemu():
    print("Starting QEMU vm!")
    return subprocess.Popen(QEMU_CMD)


def main():
    ensure_host_log_dir()
    create_seed_iso()
    vm = start_qemu()
    print("The container inside the VM will write logs to:", HOST_LOG_DIR)
    vm.wait()


if __name__ == "__main__":
    main()
